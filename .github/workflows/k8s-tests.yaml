name: Kubernetes Tests
on:
  pull_request:
jobs:
  k8s_tests:
    name: k8s tests
    runs-on: ubuntu-18.04
    steps:
      - name: Cancel Previous Actions
        uses: styfle/cancel-workflow-action@0.4.1
        with:
          access_token: ${{ github.token }}
      - name: Free disk space
        run: |
          echo "Before clearing disk space:"
          df -h

          # https://github.com/actions/virtual-environments/issues/709
          sudo apt-get clean

          # Clean up pre-installed tools
          # https://github.com/actions/virtual-environments/issues/1918
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf $AGENT_TOOLSDIRECTORY

          echo "After clearing disk space:"
          df -h
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.18.1
        id: go
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/cache@v1
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: engineerd/setup-kind@v0.5.0
        with:
          version: v0.11.1
      - uses: azure/setup-kubectl@v1
        id: kubectl
        with:
          version: 'v1.22.4'
      - uses: azure/setup-helm@v1
        with:
          version: v3.6.3
      - name: Run tests
        env:
          ACK_GINKGO_RC: true
          ACK_GINKGO_DEPRECATIONS: 1.16.5
          GOLANG_PROTOBUF_REGISTRATION_CONFLICT: warn
          RUN_CONSUL_TESTS: 0
          RUN_VAULT_TESTS: 0
          SKIP_MOCK_GEN: 1
        run: |
          make update-deps run-k8s-tests
      - name: Debug Info
        if: failure()
        run: |
          # see what's in the cluster if we failed
          kubectl get all -A